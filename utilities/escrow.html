<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Escrow - The Documentation of Metis</title>
                

        <!-- Custom HTML head -->
        

        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

                <link rel="icon" href="../favicon.svg">
                        <link rel="shortcut icon" href="../favicon.png">
                <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
                <link rel="stylesheet" href="../css/print.css" media="print">
        
        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
                <link rel="stylesheet" href="../fonts/fonts.css">
        
        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        
            </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="../overview.html"><strong aria-hidden="true">1.</strong> Overview</a></li><li class="chapter-item expanded "><a href="../use-component.html"><strong aria-hidden="true">2.</strong> Use Component</a></li><li class="chapter-item expanded "><a href="../access-control.html"><strong aria-hidden="true">3.</strong> Access Control</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../access-control/ownable.html"><strong aria-hidden="true">3.1.</strong> Ownable</a></li><li class="chapter-item expanded "><a href="../access-control/access-control.html"><strong aria-hidden="true">3.2.</strong> Access Control</a></li><li class="chapter-item expanded "><a href="../access-control/access-control-enumerable.html"><strong aria-hidden="true">3.3.</strong> Access Control Enumerable</a></li></ol></li><li class="chapter-item expanded "><a href="../governance.html"><strong aria-hidden="true">4.</strong> Governance</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../governance/timelock-controller.html"><strong aria-hidden="true">4.1.</strong> Timelock Controller</a></li></ol></li><li class="chapter-item expanded "><a href="../tokens.html"><strong aria-hidden="true">5.</strong> Tokens</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../tokens/erc20.html"><strong aria-hidden="true">5.1.</strong> ERC20</a></li><li class="chapter-item expanded "><a href="../tokens/erc721.html"><strong aria-hidden="true">5.2.</strong> ERC721</a></li><li class="chapter-item expanded "><a href="../tokens/erc777.html"><strong aria-hidden="true">5.3.</strong> ERC777</a></li><li class="chapter-item expanded "><a href="../tokens/erc1155.html"><strong aria-hidden="true">5.4.</strong> ERC1155</a></li></ol></li><li class="chapter-item expanded "><a href="../utilities.html"><strong aria-hidden="true">6.</strong> Utilities</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../utilities/escrow.html" class="active"><strong aria-hidden="true">6.1.</strong> Escrow</a></li></ol></li><li class="chapter-item expanded "><a href="../security.html"><strong aria-hidden="true">7.</strong> Security</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../security/pausable.html"><strong aria-hidden="true">7.1.</strong> Pausable</a></li><li class="chapter-item expanded "><a href="../security/reentrancy-guard.html"><strong aria-hidden="true">7.2.</strong> Reentrancy Guard</a></li></ol></li><li class="chapter-item expanded "><a href="../tools.html"><strong aria-hidden="true">8.</strong> Tools</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../tools/erc165.html"><strong aria-hidden="true">8.1.</strong> ERC165</a></li></ol></li></ol>            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                                                <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                                            </div>

                    <h1 class="menu-title">The Documentation of Metis</h1>

                    <div class="right-buttons">
                                                <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                                                                        
                    </div>
                </div>

                                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                
                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="escrow"><a class="header" href="#escrow">Escrow</a></h1>
<p>Base escrow contract, holds funds designated for a payee until they
withdraw them.</p>
<p>Intended usage: This contract (and derived escrow contracts) should be a
standalone contract, that only interacts with the contract that instantiated
it. That way, it is guaranteed that all Ether will be handled according to
the <code>Escrow</code> rules, and there is no need to check for payable functions or
transfers in the inheritance tree. The contract that uses the escrow as its
payment method should be its owner, and provide public methods redirecting
to the escrow's deposit and withdraw.</p>
<h2 id="usage"><a class="header" href="#usage">Usage</a></h2>
<p>To use <code>Escrow</code> component, should import escrow, in most cases it also need a access control component, the example we use ownable:</p>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>#[metis_lang::contract]
pub mod mock {
    use metis_escrow as escrow;
    use metis_lang::{
        import,
        metis,
    };
    use metis_ownable as ownable;

    #[ink(storage)]
    #[import(ownable, escrow)]
    pub struct Escrow {
        ownable: ownable::Data&lt;Escrow&gt;,
        escrow: escrow::Data&lt;Escrow&gt;,
    }

    // others
}
<span class="boring">}
</span></code></pre></pre>
<p>then define the events:</p>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>    /// Event emitted when payee deposit amount
    #[ink(event)]
    #[metis(escrow)]
    pub struct Deposited {
        #[ink(topic)]
        pub payee: AccountId,
        pub amount: Balance,
    }

    /// Event emitted when payee withdraw
    #[ink(event)]
    #[metis(escrow)]
    pub struct Withdrawn {
        #[ink(topic)]
        pub payee: AccountId,
        pub amount: Balance,
    }

    /// Event emitted when Owner AccountId Transferred
    #[ink(event)]
    #[metis(ownable)]
    pub struct OwnershipTransferred {
        /// previous owner account id
        #[ink(topic)]
        previous_owner: Option&lt;AccountId&gt;,
        /// new owner account id
        #[ink(topic)]
        new_owner: Option&lt;AccountId&gt;,
    }
<span class="boring">}
</span></code></pre></pre>
<p><code>OwnershipTransferred</code> event is for ownable component.</p>
<p>Add the constructor:</p>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>        #[ink(constructor)]
        pub fn new() -&gt; Self {
            let mut instance = Self {
                ownable: ownable::Data::new(),
                escrow: escrow::Data::new(),
            };

            ownable::Impl::init(&amp;mut instance);

            // escrow not need init

            instance
        }

<span class="boring">}
</span></code></pre></pre>
<p>The messages, not forget the <code>payable</code>:</p>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>        /// return the deposits of account
        #[ink(message)]
        pub fn deposits_of(&amp;self, payee: AccountId) -&gt; Balance {
            escrow::Impl::deposits_of(self, &amp;payee)
        }

        /// deposit by payee, the pay value is the amount to transfer
        #[ink(message, payable)]
        pub fn deposit(&amp;mut self, payee: AccountId) {
            ownable::Impl::ensure_caller_is_owner(self);
            escrow::Impl::deposit(self, payee)
        }

        // withdraw all deposits from the payee
        #[ink(message)]
        pub fn withdraw(&amp;mut self, payee: AccountId) {
            ownable::Impl::ensure_caller_is_owner(self);
            escrow::Impl::withdraw(self, payee)
        }
<span class="boring">}
</span></code></pre></pre>
<p>In most cases, the owner of escrow contract should be another contract, the contract call the <code>deposit</code> and <code>withdraw</code> from its contract.</p>
<p>To call the escrow contract, developer can use the <a href="%5B../../../crates/components/utils/stub/src/lib.rs%5D(https://github.com/patractlabs/metis/blob/master/crates/components/utils/escrow/stub/src/lib.rs)">stub</a> of the escrow</p>
<h2 id="module"><a class="header" href="#module">Module</a></h2>
<p>the deposits is the map of payee to balance:</p>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>/// The Data of escrow component
#[cfg_attr(feature = &quot;std&quot;, derive(::ink_storage::traits::StorageLayout))]
#[derive(Debug, SpreadLayout)]
pub struct Data&lt;E&gt;
where
    E: Env,
{
    /// The owner of contract
    pub deposits: StorageHashMap&lt;E::AccountId, E::Balance&gt;,
}
<span class="boring">}
</span></code></pre></pre>
<h2 id="messages-for-txs"><a class="header" href="#messages-for-txs">Messages for Txs</a></h2>
<h3 id="deposit"><a class="header" href="#deposit">deposit</a></h3>
<p>Stores the sent amount as credit to be withdrawn.</p>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>    /// Stores the sent amount as credit to be withdrawn.
    /// @param payee The destination address of the funds.
    fn deposit(&amp;mut self, payee: E::AccountId) {
        self.ensure_caller_is_owner();

        let amount = Self::transferred_balance();

        Storage::&lt;E, Data&lt;E&gt;&gt;::get_mut(self).add(&amp;payee, &amp;amount);

        self.emit_event_deposited(payee, amount);
    }
<span class="boring">}
</span></code></pre></pre>
<h3 id="withdraw"><a class="header" href="#withdraw">withdraw</a></h3>
<p>Withdraw accumulated balance for a payee, forwarding all gas to the recipient.</p>
<blockquote>
<p>WARNING: Forwarding all gas opens the door to reentrancy vulnerabilities.
Make sure you trust the recipient, or are either following the
checks-effects-interactions pattern or using {ReentrancyGuard}.</p>
</blockquote>
<p>param:</p>
<ul>
<li><code>payee</code> : The address whose funds will be withdrawn and transferred to.</li>
</ul>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>    /// @dev Withdraw accumulated balance for a payee, forwarding all gas to the
    /// recipient.
    ///
    /// WARNING: Forwarding all gas opens the door to reentrancy vulnerabilities.
    /// Make sure you trust the recipient, or are either following the
    /// checks-effects-interactions pattern or using {ReentrancyGuard}.
    ///
    /// @param payee The address whose funds will be withdrawn and transferred to.
    fn withdraw(&amp;mut self, payee: E::AccountId) {
        self.ensure_caller_is_owner();

        let payment = Storage::&lt;E, Data&lt;E&gt;&gt;::get(self).get(&amp;payee);

        Storage::&lt;E, Data&lt;E&gt;&gt;::get_mut(self).clean(&amp;payee);

        let res = Self::transfer(payee.clone(), payment);
        assert!(res.is_ok(), &quot;Escrow: transfer to payee error&quot;);

        self.emit_event_withdrawn(payee, payment);
    }
<span class="boring">}
</span></code></pre></pre>
<h2 id="message-for-querys"><a class="header" href="#message-for-querys">Message for Querys</a></h2>
<h3 id="deposits_of"><a class="header" href="#deposits_of">deposits_of</a></h3>
<p>Return the deposits of payee</p>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>    /// Return the deposits of payee
    fn deposits_of(&amp;self, payee: &amp;E::AccountId) -&gt; E::Balance {
        Storage::&lt;E, Data&lt;E&gt;&gt;::get(self).get(payee)
    }
<span class="boring">}
</span></code></pre></pre>
<h2 id="events"><a class="header" href="#events">Events</a></h2>
<h3 id="deposited"><a class="header" href="#deposited">Deposited</a></h3>
<p>Event emitted when payee deposit amount</p>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>    /// Event emitted when payee deposit amount
    #[ink(event)]
    #[metis(escrow)]
    pub struct Deposited {
        #[ink(topic)]
        pub payee: AccountId,
        pub amount: Balance,
    }
<span class="boring">}
</span></code></pre></pre>
<h3 id="withdrawn"><a class="header" href="#withdrawn">Withdrawn</a></h3>
<p>Event emitted when payee withdraw</p>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>    /// Event emitted when payee withdraw
    #[ink(event)]
    #[metis(escrow)]
    pub struct Withdrawn {
        #[ink(topic)]
        pub payee: AccountId,
        pub amount: Balance,
    }
<span class="boring">}
</span></code></pre></pre>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                                                    <a rel="prev" href="../utilities.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        
                                                    <a rel="next" href="../security.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        
                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                                    <a rel="prev" href="../utilities.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                
                                    <a rel="next" href="../security.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                            </nav>

        </div>

        
        
        
                <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        
        
                <script src="../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../searcher.js" type="text/javascript" charset="utf-8"></script>
        
        <script src="../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        
        
    </body>
</html>
